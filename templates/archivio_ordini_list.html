{% extends "base.html" %}

{% block title %}Archivio ordini · Backup ordini 2025{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Archivio ordini</h1>
        <p class="text-sm text-gray-500 mt-1">Backup ordini del 2025</p>
      </div>
      <a href="{{ url_for('home') }}"
         class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Torna alla dashboard
      </a>
    </div>
  </div>

  <div id="archiveRunCard" class="bg-amber-50 border border-amber-200 rounded-xl p-4">
    <button type="button" id="btnRunArchive"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
      Esegui archivio
    </button>
    <div id="archiveRunResult" class="mt-4 hidden text-sm"></div>
  </div>

  <!-- Ricerca e elenco -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex flex-col sm:flex-row gap-4 mb-4">
      <input type="search" id="searchInput" placeholder="Cerca per seriale, numero ordine, cliente..."
             class="flex-1 rounded-lg border border-gray-300 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      <button type="button" id="btnSearch"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700">
        Cerca
      </button>
    </div>
    <div id="archiveList" class="space-y-2 min-h-[200px]">
      <p class="text-gray-500 text-sm">Caricamento...</p>
    </div>
    <div id="archivePagination" class="mt-4 flex items-center justify-between border-t border-gray-200 pt-4"></div>
  </div>
</div>

<script>
(function() {
  let currentPage = 1;
  let totalPages = 1;
  const perPage = 20;

  function loadList(page, q) {
    const url = new URL('/api/archivio/orders', window.location.origin);
    url.searchParams.set('page', page);
    url.searchParams.set('per_page', perPage);
    if (q) url.searchParams.set('q', q);
    document.getElementById('archiveList').innerHTML = '<p class="text-gray-500 text-sm">Caricamento...</p>';
    fetch(url, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => {
        if (!data.success) {
          document.getElementById('archiveList').innerHTML = '<p class="text-red-600">Errore caricamento.</p>';
          return;
        }
        currentPage = data.page;
        totalPages = data.total_pages || 1;
        const orders = data.orders || [];
        if (orders.length === 0) {
          document.getElementById('archiveList').innerHTML = '<p class="text-gray-500">Nessun ordine in archivio.</p>';
        } else {
          document.getElementById('archiveList').innerHTML = orders.map(o => `
            <a href="/archivio-ordini/${o.seriale}" class="block p-4 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <span class="font-medium text-gray-900">${o.nome_cliente || '—'}</span>
                <span class="text-sm text-gray-500">N. ${o.numero_ordine || '—'} · Seriale ${o.seriale}</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">Data ordine: ${o.data_ordine || '—'}</div>
            </a>
          `).join('');
        }
        renderPagination();
      })
      .catch(() => {
        document.getElementById('archiveList').innerHTML = '<p class="text-red-600">Errore di rete.</p>';
      });
  }

  function renderPagination() {
    const el = document.getElementById('archivePagination');
    if (totalPages <= 1) {
      el.innerHTML = '';
      return;
    }
    el.innerHTML = `
      <button type="button" ${currentPage <= 1 ? 'disabled' : ''} data-page="${currentPage - 1}"
              class="px-3 py-1 rounded border border-gray-300 text-sm disabled:opacity-50">Indietro</button>
      <span class="text-sm text-gray-600">Pagina ${currentPage} di ${totalPages}</span>
      <button type="button" ${currentPage >= totalPages ? 'disabled' : ''} data-page="${currentPage + 1}"
              class="px-3 py-1 rounded border border-gray-300 text-sm disabled:opacity-50">Avanti</button>
    `;
    el.querySelectorAll('button[data-page]').forEach(btn => {
      btn.addEventListener('click', () => loadList(parseInt(btn.dataset.page, 10), document.getElementById('searchInput').value.trim()));
    });
  }

  document.getElementById('btnSearch').addEventListener('click', () => {
    loadList(1, document.getElementById('searchInput').value.trim());
  });
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') loadList(1, document.getElementById('searchInput').value.trim());
  });

  document.getElementById('btnRunArchive').addEventListener('click', function() {
    const btn = this;
    const resultEl = document.getElementById('archiveRunResult');
    btn.disabled = true;
    resultEl.classList.remove('hidden');
    resultEl.innerHTML = 'Archiviazione in corso...';
    fetch('/api/archivio/run-2025', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' } })
      .then(r => r.json())
      .then(data => {
        btn.disabled = false;
        if (data.success) {
          resultEl.innerHTML = `Archiviati: <strong>${data.archived}</strong>, aggiornati: ${data.updated || 0}, candidati: ${data.total_candidates}. ${(data.errors && data.errors.length) ? 'Errori: ' + data.errors.join('; ') : ''}`;
          loadList(1, '');
        } else {
          resultEl.innerHTML = '<span class="text-red-600">Errore</span>';
        }
      })
      .catch(() => {
        btn.disabled = false;
        resultEl.innerHTML = '<span class="text-red-600">Errore di rete</span>';
      });
  });

  loadList(1, '');
})();
</script>
{% endblock %}
