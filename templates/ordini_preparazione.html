{% extends "base.html" %}

{% block title %}Ordini in Preparazione{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ðŸ”„ Ordini in Preparazione</h1>
        <p class="text-gray-600">Gestisci gli ordini in fase di preparazione</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <input type="text" id="searchInput" placeholder="Cerca ordini..." 
                   class="block w-full pl-12 pr-4 py-4 text-lg border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
        </div>
    </div>

    <!-- Filtri per Reparto (solo per cassiere) -->
    {% if not current_user.reparto %}
    <div class="mb-6 bg-blue-50 rounded-xl p-6 border border-blue-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">ðŸ“Š Filtri per Reparto</h3>
        
        <!-- Bottoni Reparti -->
        <div class="mb-4">
            <div class="flex flex-wrap gap-3">
                <button class="reparto-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 {% if reparto_filter == 'tutti' %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:border-blue-400{% endif %}" 
                        data-reparto="tutti">
                    <div class="text-sm font-semibold">Tutti</div>
                    <div class="text-xs">{{ total_orders_in_preparation }} ordini</div>
                </button>
                
                <button class="reparto-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 {% if reparto_filter == 'REP01' %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:border-blue-400{% endif %}" 
                        data-reparto="REP01">
                    <div class="text-sm font-semibold">REP01</div>
                    <div class="text-xs">PROFILATI</div>
                </button>
                
                <button class="reparto-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 {% if reparto_filter == 'REP02' %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:border-blue-400{% endif %}" 
                        data-reparto="REP02">
                    <div class="text-sm font-semibold">REP02</div>
                    <div class="text-xs">EDILE</div>
                </button>
                
                <button class="reparto-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 {% if reparto_filter == 'REP03' %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:border-blue-400{% endif %}" 
                        data-reparto="REP03">
                    <div class="text-sm font-semibold">REP03</div>
                    <div class="text-xs">TRAVI</div>
                </button>
                
                <button class="reparto-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 {% if reparto_filter == 'REP04' %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:border-blue-400{% endif %}" 
                        data-reparto="REP04">
                    <div class="text-sm font-semibold">REP04</div>
                    <div class="text-xs">COIBENTATI</div>
                </button>
                
                <button class="reparto-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 {% if reparto_filter == 'REP05' %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-700 border-gray-300 hover:border-blue-400{% endif %}" 
                        data-reparto="REP05">
                    <div class="text-sm font-semibold">REP05</div>
                    <div class="text-xs">FERRAMENTA</div>
                </button>
            </div>
        </div>
        
        <!-- Contatore Reparto Selezionato -->
        <div class="mt-4 text-center">
            <div class="inline-flex items-center px-6 py-3 bg-gray-800 text-white rounded-lg">
                <span class="text-lg font-semibold">
                    {% if reparto_filter == 'tutti' %}
                        Totale Ordini in Preparazione: {{ total_orders_in_preparation }}
                    {% else %}
                        Ordini {{ reparto_filter }} in Preparazione: {{ reparti_counters.get('selected_count', 0) }}
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- Orders Grid (Tablet-friendly) -->
    <div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for order in orders %}
        <div class="order-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-lg transition-all duration-200 cursor-pointer" 
             data-href="{{ url_for('order_detail', seriale=order.seriale, back='preparazione') }}"
             onclick="handleCardClick(this)">
            <!-- Order Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                    <h3 class="text-lg font-bold text-gray-900">{{ order.numero_ordine }}</h3>
                </div>
                <div class="text-sm text-gray-500">{{ order.data_ordine }}</div>
            </div>
            
            <!-- Customer Info -->
            <div class="mb-4">
                <div class="flex items-center space-x-2 mb-2">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-900">{{ order.nome_cliente }}</span>
                </div>
            </div>
            
            <!-- Status Info -->
            <div class="mb-4">
                {% if current_user.reparto %}
                    <!-- Per i picker: mostra solo l'operatore del loro reparto -->
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <span class="text-sm font-medium text-blue-600">{{ order.status.operatore or 'Non assegnato' }}</span>
                    </div>
                {% else %}
                    <!-- Per i cassiere: mostra lo stato per reparto -->
                    {% if order.status_summary %}
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                <span class="text-sm font-medium text-blue-600">Stato per Reparto</span>
                            </div>
                            <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border reparto-info">
                                {{ order.status_summary }}
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Read Status -->
            <div class="mb-4">
                {% if order.read_by %}
                    <div class="flex flex-wrap gap-1">
                        {% for reader in order.read_by %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                {{ reader }}
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <span class="text-sm text-gray-400">Non letto</span>
                {% endif %}
            </div>
            
            <!-- Action Indicator -->
            <div class="mt-4 flex items-center justify-end text-blue-600 text-sm font-medium">
                <span>Tocca per continuare preparazione</span>
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
        <div class="max-w-md mx-auto">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900">Nessun ordine in preparazione</h3>
            <p class="mt-2 text-sm text-gray-500">Non ci sono ordini che corrispondono ai criteri di ricerca.</p>
        </div>
    </div>
</div>

<style>
.order-card {
    transition: all 0.15s ease-in-out;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    touch-action: manipulation;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.order-card:active {
    transform: translateY(0) scale(0.98);
    background-color: #f8fafc;
}

@media (max-width: 768px) {
    .order-card {
        margin-bottom: 1rem;
        min-height: 200px; /* Assicura che la card sia abbastanza grande per il touch */
        padding: 1.5rem; /* Aumenta il padding per un'area touch piÃ¹ grande */
    }
    
    .order-card:active {
        transform: scale(0.98);
        background-color: #f8fafc;
    }
    
    /* Migliora l'area touch */
    .order-card * {
        pointer-events: none; /* Previene eventi sui figli */
    }
    
    /* Permetti ai bottoni di funzionare */
    .order-card button {
        pointer-events: auto !important;
    }
}
</style>

<script>
// Funzione globale per gestire i click sulle card
function handleCardClick(card) {
    const href = card.getAttribute('data-href');
    if (href) {
        console.log('ðŸ”„ Navigazione verso:', href);
        // Aggiungi feedback visivo
        card.style.transform = 'scale(0.98)';
        card.style.backgroundColor = '#f8fafc';
        
        // Naviga dopo un breve delay per il feedback
        setTimeout(() => {
            window.location.href = href;
        }, 150);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const ordersGrid = document.getElementById('ordersGrid');
    const emptyState = document.getElementById('emptyState');
    const orderCards = document.querySelectorAll('.order-card');

    function filterOrders() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleCount = 0;

        orderCards.forEach(card => {
            const text = card.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Mostra/nascondi lo stato vuoto
        if (visibleCount === 0 && searchTerm) {
            emptyState.classList.remove('hidden');
            ordersGrid.style.display = 'none';
        } else {
            emptyState.classList.add('hidden');
            ordersGrid.style.display = '';
        }
    }

    // Event listeners
    searchInput.addEventListener('input', filterOrders);
    
    // Filtro per reparto con bottoni (solo per cassiere)
    const repartoButtons = document.querySelectorAll('.reparto-btn');
    if (repartoButtons.length > 0) {
        repartoButtons.forEach(button => {
            button.addEventListener('click', function() {
                const selectedReparto = this.getAttribute('data-reparto');
                
                // Aggiorna URL con il filtro selezionato
                const url = new URL(window.location);
                if (selectedReparto === 'tutti') {
                    url.searchParams.delete('reparto');
                } else {
                    url.searchParams.set('reparto', selectedReparto);
                }
                window.location.href = url.toString();
            });
        });
    }
    
    // Focus on search input for better tablet experience
    searchInput.focus();
    
    // Aggiungi event listeners touch per ogni card
    orderCards.forEach(card => {
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        
        // Gestione touch per mobile
        card.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchMoved = false;
        });
        
        card.addEventListener('touchmove', function(e) {
            if (e.touches[0].clientX !== touchStartX || e.touches[0].clientY !== touchStartY) {
                touchMoved = true;
            }
        });
        
        card.addEventListener('touchend', function(e) {
            // Se il touch Ã¨ su un bottone, non fare nulla (il bottone gestirÃ  il click)
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                return;
            }
            
            const touchDuration = Date.now() - touchStartTime;
            const touchDistance = Math.sqrt(
                Math.pow(e.changedTouches[0].clientX - touchStartX, 2) + 
                Math.pow(e.changedTouches[0].clientY - touchStartY, 2)
            );
            
            // Solo se Ã¨ un tap (non scroll) e non troppo lungo
            if (!touchMoved && touchDuration < 500 && touchDistance < 10) {
                e.preventDefault();
                e.stopPropagation();
                const href = card.getAttribute('data-href');
                if (href) {
                    // Aggiungi feedback visivo
                    card.style.transform = 'scale(0.98)';
                    card.style.backgroundColor = '#f8fafc';
                    
                    // Naviga dopo un breve delay
                    setTimeout(() => {
                        window.location.href = href;
                    }, 150);
                }
            }
        });
        
        // Gestione click per desktop
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const href = card.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });
    
    // Inizializza lo stato
    filterOrders();
});
</script>
{% endblock %}
