{% extends "base.html" %}

{% block title %}Elenco Ordini{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ðŸ“‹ Elenco Ordini</h1>
        <p class="text-gray-600">Gestisci tutti gli ordini clienti</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <input type="text" id="searchInput" placeholder="Cerca in TUTTI gli ordini, clienti, articoli..."
                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <!-- Search Status -->
        <div id="searchStatus" class="mt-2 text-sm text-gray-600 hidden">
            <span id="searchStatusText">Cercando...</span>
        </div>
        
        <!-- Test Notification Button -->
        <div class="mt-4 flex justify-end">
            <button id="testNotificationBtn" 
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                ðŸ”” Test Notifica
            </button>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Ordini Clienti</h2>
            <p class="text-sm text-gray-500 mt-1">Ultimo aggiornamento: <span id="lastUpdate">-</span></p>
        </div>
        
        <!-- Desktop Table -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ordine
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Data
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Cliente
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Azioni
                        </th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Orders will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Mobile Cards -->
        <div class="md:hidden space-y-4" id="mobileOrdersContainer">
            <!-- Mobile orders will be loaded here -->
        </div>
        
        
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-2 text-sm text-gray-500">Caricamento ordini...</p>
        </div>
        
        <!-- Infinite Scroll Trigger -->
        <div id="loadTrigger" class="h-4 flex items-center justify-center">
            <div id="loadingIndicator" class="hidden">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm text-gray-500">Caricamento...</p>
            </div>
        </div>
        
    </div>
</div>

<!-- Audio element for notification sound -->
<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
</audio>

<!-- Alternative notification sound (stronger beep) -->
<audio id="strongNotificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
</audio>

<!-- Visual notification overlay -->
<div id="notificationOverlay" class="fixed inset-0 pointer-events-none z-50 hidden">
  <div class="absolute inset-0 border-8 border-red-500 animate-pulse"></div>
</div>

<style>
@keyframes flash-border {
  0%, 100% { border-color: transparent; }
  50% { border-color: #ef4444; }
}

.flash-border {
  animation: flash-border 0.5s ease-in-out infinite;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.shake {
  animation: shake 0.3s ease-in-out infinite;
}

.active\:scale-98:active {
  transform: scale(0.98);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ordersTableBody = document.getElementById('ordersTableBody');
    const searchInput = document.getElementById('searchInput');
    const loadingState = document.getElementById('loadingState');
    const lastUpdate = document.getElementById('lastUpdate');
    const notificationSound = document.getElementById('notificationSound');
    const strongNotificationSound = document.getElementById('strongNotificationSound');
    const notificationOverlay = document.getElementById('notificationOverlay');
    const searchStatus = document.getElementById('searchStatus');
    const searchStatusText = document.getElementById('searchStatusText');
    
    let currentOrders = [];
    let lastOrderCount = 0;
    let lastOrderSeriali = new Set(); // Per tenere traccia dei seriali degli ordini precedenti
    let isFirstLoad = true; // Flag per il primo caricamento
    let isPolling = true;
    // Traccia gli ordini giÃ  notificati - usa sessionStorage per persistenza tra navigazioni
    let notifiedOrders = new Set();
    // Carica ordini giÃ  notificati da sessionStorage
    try {
        const savedNotified = sessionStorage.getItem('notifiedOrders');
        if (savedNotified) {
            notifiedOrders = new Set(JSON.parse(savedNotified));
        }
    } catch (e) {
        console.log('Errore nel caricamento ordini notificati:', e);
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('it-IT', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    function getStatusBadge(status) {
        if (!status || status === 'nuovo') return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Nuovo</span>';
        
        switch(status) {
            case 'letto':
                return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Ordine Letto</span>';
            // rimosso badge per materiale non disponibile: la segnalazione Ã¨ gestita dentro il dettaglio ordine sulle righe
            case 'in_preparazione':
                return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Ordine in preparazione</span>';
            case 'pronto':
                return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Ordine pronto</span>';
            default:
                return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Nuovo</span>';
        }
    }

    function displayOrders(orders) {
        if (orders.length === 0) {
            ordersTableBody.innerHTML = '';
            document.getElementById('mobileOrdersContainer').innerHTML = '';
            loadingState.classList.add('hidden');
            return;
        }

        loadingState.classList.add('hidden');
        
        // Desktop table
        ordersTableBody.innerHTML = orders.map(order => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${order.numero_ordine}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(order.data_ordine)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${order.nome_cliente || 'Cliente non disponibile'}
                    ${order.ritiro && order.ritiro.trim() ? `
                        <div class="mt-1">
                            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                                ${order.ritiro.toLowerCase().includes('ritiro') ? 'ðŸ“¦' : 
                                  order.ritiro.toLowerCase().includes('consegna') ? 'ðŸšš' : 'ðŸ“‹'} ${order.ritiro}
                            </span>
                        </div>
                    ` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${getStatusBadge(order.status)}
                    ${order.status_operatore ? `<br><span class="text-xs text-gray-400">da ${order.status_operatore}</span>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/ordine/${order.seriale}" 
                       class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                       onclick="markOrderAsRead('${order.seriale}')">
                        Visualizza
                    </a>
                </td>
            </tr>
        `).join('');

        // Mobile cards
        document.getElementById('mobileOrdersContainer').innerHTML = orders.map(order => `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md hover:border-blue-300 transition-all duration-200 cursor-pointer active:scale-98" 
                 onclick="window.location.href='/ordine/${order.seriale}'"
                 ontouchstart="markOrderAsRead('${order.seriale}')">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Ordine ${order.numero_ordine}</h3>
                        <p class="text-sm text-gray-500">${formatDate(order.data_ordine)}</p>
                    </div>
                    ${getStatusBadge(order.status)}
                </div>
                
                <div class="mb-3">
                    <p class="text-sm font-medium text-gray-900">${order.nome_cliente || 'Cliente non disponibile'}</p>
                    ${order.status_operatore ? `<p class="text-xs text-gray-500">Operatore: ${order.status_operatore}</p>` : ''}
                </div>
                
                ${order.ritiro && order.ritiro.trim() ? `
                    <div class="mb-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                            ${order.ritiro.toLowerCase().includes('ritiro') ? 'ðŸ“¦' : 
                              order.ritiro.toLowerCase().includes('consegna') ? 'ðŸšš' : 'ðŸ“‹'} ${order.ritiro}
                        </span>
                    </div>
                ` : ''}
                
                <div class="flex items-center justify-end text-blue-600 text-sm font-medium">
                    <span>Tocca per visualizzare</span>
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            </div>
        `).join('');
    }

    function filterOrders(orders, searchTerm) {
        if (!searchTerm) return orders;
        
        const term = searchTerm.toLowerCase();
        return orders.filter(order => 
            order.numero_ordine.toLowerCase().includes(term) ||
            (order.nome_cliente && order.nome_cliente.toLowerCase().includes(term)) ||
            order.seriale.toLowerCase().includes(term) ||
            (order.codice_articolo && order.codice_articolo.toLowerCase().includes(term)) ||
            (order.descrizione_articolo && order.descrizione_articolo.toLowerCase().includes(term)) ||
            (order.descrizione_supplementare && order.descrizione_supplementare.toLowerCase().includes(term)) ||
            (order.ritiro && order.ritiro.toLowerCase().includes(term))
        );
    }

    async function playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // BEEP SINGOLO FORTISSIMO PER AMBIENTE ESTERNO
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Suono fortissimo: frequenza alta e volume massimo
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(1200, audioContext.currentTime); // Frequenza alta per essere piÃ¹ udibile
            
            // Volume MASSIMO per ambiente esterno
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1.0, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            
            // Beep lungo e forte
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.8);
            
            console.log(`ðŸ”Š Suono di notifica: BEEP SINGOLO FORTISSIMO (0.8s, 1200Hz)`);
            
            // Backup con file audio se disponibile
            try {
                notificationSound.currentTime = 0;
                notificationSound.volume = 1.0; // Volume massimo
                await notificationSound.play();
            } catch (audioError) {
                console.log('Audio file playback failed:', audioError);
            }
            
        } catch (error) {
            console.log('Web Audio API failed:', error);
            // Fallback: beep singolo fortissimo
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
                
                // Beep singolo fortissimo di 0.8 secondi
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
            } catch (fallbackError) {
                console.log('Fallback audio also failed:', fallbackError);
            }
        }
    }

    function showVisualNotification() {
        // Show the red border overlay
        notificationOverlay.classList.remove('hidden');
        
        // Add shake effect to the page
        document.body.classList.add('shake');
        
        // Flash effect piÃ¹ intenso
        let flashCount = 0;
        const flashInterval = setInterval(() => {
            if (flashCount % 2 === 0) {
                notificationOverlay.style.opacity = '0.8';
            } else {
                notificationOverlay.style.opacity = '0.3';
            }
            flashCount++;
            if (flashCount >= 8) { // 4 flash completi
                clearInterval(flashInterval);
                notificationOverlay.style.opacity = '0.6';
            }
        }, 200);
        
        // Hide after 6 seconds (piÃ¹ lungo per ambiente esterno)
        setTimeout(() => {
            notificationOverlay.classList.add('hidden');
            document.body.classList.remove('shake');
            notificationOverlay.style.opacity = '0.6'; // Reset opacity
        }, 6000);
    }

    // Funzione per marcare un ordine come letto (solo per picker)
    async function markOrderAsRead(seriale) {
        // Solo per picker (hanno un reparto)
        const userRole = '{{ current_user.role }}';
        const userReparto = '{{ current_user.reparto or "" }}';
        
        if (userRole === 'picker' && userReparto) {
            try {
                await fetch(`/api/order/${seriale}/read`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                console.log(`ðŸ“– Ordine ${seriale} marcato come letto`);
            } catch (error) {
                console.log('Errore nel marcare ordine come letto:', error);
            }
        }
    }


    // Variabili per la paginazione
    let currentPage = 1;
    let hasMore = true;
    let allOrders = [];
    
    async function loadOrders(page = 1, append = false) {
        try {
            const response = await fetch(`/api/orders?page=${page}`, {
                credentials: 'same-origin'
            });
            const data = await response.json();
            
            if (page === 1) {
                // Prima pagina - sostituisci tutto
                allOrders = data.orders;
                currentOrders = data.orders;
            } else {
                // Pagine successive - aggiungi
                allOrders = [...allOrders, ...data.orders];
                currentOrders = allOrders;
            }
            
            hasMore = data.has_more;
            currentPage = page;
            
            // Solo se non stiamo cercando, applica il filtro locale
            if (!isSearching) {
                const filteredOrders = filterOrders(currentOrders, searchInput.value);
                displayOrders(filteredOrders);
            } else {
                // Durante la ricerca, mostra gli ordini cosÃ¬ come sono
                displayOrders(currentOrders);
            }
            
            // Update last update time
            lastUpdate.textContent = new Date().toLocaleTimeString('it-IT');
            
            // Pulisci gli ordini letti dal tracking delle notifiche
            let needsSave = false;
            data.orders.forEach(order => {
                if (order.status && order.status !== 'nuovo') {
                    if (notifiedOrders.has(order.seriale)) {
                        notifiedOrders.delete(order.seriale);
                        needsSave = true;
                    }
                }
            });
            
            // Salva aggiornamenti in sessionStorage se necessario
            if (needsSave) {
                try {
                    sessionStorage.setItem('notifiedOrders', JSON.stringify([...notifiedOrders]));
                } catch (e) {
                    console.log('Errore nel salvataggio ordini notificati:', e);
                }
            }
            
            
            // Nascondi l'indicatore di caricamento
            hideLoadingIndicator();
            isLoading = false;
            
            // Check for new orders and play sound
            const currentOrderSeriali = new Set(data.orders.map(order => order.seriale));
            
            // Trova gli ordini effettivamente nuovi (seriali non presenti prima)
            const newOrderSeriali = new Set();
            for (const seriale of currentOrderSeriali) {
                if (!lastOrderSeriali.has(seriale)) {
                    newOrderSeriali.add(seriale);
                }
            }
            
            // Trova gli ordini nuovi E non letti (status "nuovo" o undefined)
            const newUnreadOrders = data.orders.filter(order => 
                newOrderSeriali.has(order.seriale) && 
                (!order.status || order.status === 'nuovo')
            );
            
            // Filtra solo gli ordini che non sono stati ancora notificati
            const ordersToNotify = newUnreadOrders.filter(order => 
                !notifiedOrders.has(order.seriale)
            );
            
            // LOGICA SEMPLIFICATA: Suona SOLO durante auto-refresh automatico, non durante scroll o reload manuali
            // Controlla se questa Ã¨ una chiamata di auto-refresh (non scroll o reload)
            const isAutoRefresh = !isSearching && !append && page === 1;
            
            if (ordersToNotify.length > 0 && !isFirstLoad && isAutoRefresh) {
                console.log(`ðŸŽ‰ NUOVI ORDINI ARRIVATI: ${ordersToNotify.length}`);
                console.log('Nuovi seriali:', ordersToNotify.map(o => o.seriale));
                
                // Marca questi ordini come notificati
                ordersToNotify.forEach(order => {
                    notifiedOrders.add(order.seriale);
                });
                
                // Salva in sessionStorage per persistenza tra navigazioni
                try {
                    sessionStorage.setItem('notifiedOrders', JSON.stringify([...notifiedOrders]));
                } catch (e) {
                    console.log('Errore nel salvataggio ordini notificati:', e);
                }
                
                // Play notification sound SOLO per nuovi ordini durante auto-refresh
                await playNotificationSound();
                
                // Vibrazione lunga per tablet (se supportata)
                if (navigator.vibrate) {
                    navigator.vibrate([300, 200, 300, 200, 300, 200, 300, 200, 300]);
                }
                
                // Show visual notification
                showVisualNotification();
                
                // Show browser notification if supported
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Nuovi Ordini', {
                        body: `${ordersToNotify.length} nuovo ordine/i arrivato/i!`,
                        icon: '/favicon.ico',
                        requireInteraction: true,
                        tag: 'new-orders'
                    });
                }
                
                // Flash the page title to draw attention
                const originalTitle = document.title;
                let flashCount = 0;
                const flashInterval = setInterval(() => {
                    document.title = flashCount % 2 === 0 ? 'ðŸš¨ NUOVI ORDINI!' : originalTitle;
                    flashCount++;
                    if (flashCount >= 10) {
                        clearInterval(flashInterval);
                        document.title = originalTitle;
                    }
                }, 500);
            }
            
            // Aggiorna sempre i contatori
            lastOrderCount = data.orders.length;
            lastOrderSeriali = currentOrderSeriali;
            
            // Dopo il primo caricamento, imposta il flag a false
            if (isFirstLoad) {
                isFirstLoad = false;
                console.log('ðŸš€ Primo caricamento completato - Notifiche attive');
            }
            
        } catch (error) {
            console.error('Error loading orders:', error);
            loadingState.classList.add('hidden');
            hideLoadingIndicator();
            isLoading = false;
        }
    }

    // Search functionality - cerca in TUTTI gli ordini
    let searchTimeout;
    let isSearching = false; // Flag per gestire lo stato di ricerca
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        // Debounce: aspetta 300ms dopo l'ultima digitazione
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            if (searchTerm.length === 0) {
                // Se la ricerca Ã¨ vuota, torna alla visualizzazione normale
                isSearching = false;
                displayOrders(currentOrders);
                searchStatus.classList.add('hidden');
                return;
            }
            
            if (searchTerm.length < 2) {
                // Troppo corto per cercare
                return;
            }
            
            try {
                // Imposta flag di ricerca
                isSearching = true;
                
                // Mostra status di ricerca
                searchStatus.classList.remove('hidden');
                searchStatusText.textContent = `Cercando "${searchTerm}" in tutti gli ordini...`;
                
                // Cerca in TUTTI gli ordini tramite API
                const response = await fetch(`/api/orders/search?q=${encodeURIComponent(searchTerm)}`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                // Mostra i risultati della ricerca SENZA applicare filterOrders
                displayOrders(data.orders);
                
                // Aggiorna lo status
                if (data.total > 0) {
                    searchStatusText.textContent = `Trovati ${data.total} ordini per "${searchTerm}"`;
                    searchStatus.classList.remove('text-gray-600');
                    searchStatus.classList.add('text-green-600');
                } else {
                    searchStatusText.textContent = `Nessun ordine trovato per "${searchTerm}"`;
                    searchStatus.classList.remove('text-gray-600');
                    searchStatus.classList.add('text-red-600');
                }
                
            } catch (error) {
                console.error('Errore nella ricerca:', error);
                searchStatusText.textContent = `Errore nella ricerca: ${error.message}`;
                searchStatus.classList.remove('text-gray-600');
                searchStatus.classList.add('text-red-600');
                
                // Fallback: cerca negli ordini caricati
                const filteredOrders = filterOrders(currentOrders, searchTerm);
                displayOrders(filteredOrders);
            }
        }, 300);
    });

    // Test notification button
    document.getElementById('testNotificationBtn').addEventListener('click', async function() {
        console.log('ðŸ§ª Testing notification system...');
        await playNotificationSound();
        showVisualNotification();
        
        // Flash the page title
        const originalTitle = document.title;
        let flashCount = 0;
        const flashInterval = setInterval(() => {
            document.title = flashCount % 2 === 0 ? 'ðŸ§ª TEST NOTIFICA!' : originalTitle;
            flashCount++;
            if (flashCount >= 6) {
                clearInterval(flashInterval);
                document.title = originalTitle;
            }
        }, 500);
    });

    // Request notification permission on page load
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Initial load
    loadOrders();

    // Auto-refresh every 30 seconds - ma non durante la ricerca
    setInterval(() => {
        if (isPolling && !isSearching) {
            loadOrders(1); // Ricarica sempre dalla prima pagina
        }
    }, 30000);

    // Sistema di notifiche modifiche rimosso

    // Controllo modifiche disabilitato
    
    // Funzioni per l'infinite scroll
    
    function showLoadingIndicator() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.classList.remove('hidden');
    }
    
    function hideLoadingIndicator() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.classList.add('hidden');
    }
    
    // Debouncing per loadMoreOrders
    let loadMoreTimeout;
    
    function loadMoreOrders() {
        if (hasMore && !isLoading && !isSearching) {
            // Debounce: aspetta 100ms prima di caricare
            clearTimeout(loadMoreTimeout);
            loadMoreTimeout = setTimeout(() => {
                if (hasMore && !isLoading && !isSearching) {
                    isLoading = true;
                    showLoadingIndicator();
                    loadOrders(currentPage + 1, true);
                }
            }, 100);
        }
    }
    
    // Intersection Observer per l'infinite scroll - migliorato
    let isLoading = false;
    const loadTrigger = document.getElementById('loadTrigger');
    
    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && hasMore && !isLoading && !isSearching) {
            loadMoreOrders();
        }
    }, { 
        threshold: 0.1,
        rootMargin: '100px' // Trigger 100px prima di arrivare al trigger
    });
    
    if (loadTrigger) {
        observer.observe(loadTrigger);
    }

    // Pause polling when page is not visible
    document.addEventListener('visibilitychange', function() {
        isPolling = !document.hidden;
    });
    
    // Gestione touch per mobile/tablet
    let touchStartY = 0;
    let touchEndY = 0;
    
    document.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchend', function(e) {
        touchEndY = e.changedTouches[0].clientY;
        const touchDiff = touchStartY - touchEndY;
        
        // Se lo scroll Ã¨ significativo e siamo in fondo alla pagina, carica piÃ¹ ordini
        if (touchDiff > 50 && window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            if (hasMore && !isLoading && !isSearching) {
                loadMoreOrders();
            }
        }
    }, { passive: true });
});
</script>
{% endblock %}
